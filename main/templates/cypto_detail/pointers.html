<canvas id="priceChart" width="800" height="400"></canvas>
<canvas id="rsiChart" width="800" height="200"></canvas>
<canvas id="stochChart" width="800" height="200"></canvas>
<canvas id="cciChart" width="800" height="200"></canvas>
<canvas id="williamsChart" width="800" height="200"></canvas>
<canvas id="obvChart" width="800" height="200"></canvas>
<canvas id="mfiChart" width="800" height="200"></canvas>
<canvas id="atrChart" width="800" height="200"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let priceChart, rsiChart, stochChart, cciChart, williamsChart, obvChart, mfiChart, atrChart;

const coinId = {{ coin_id }};
console.log(coinId);

function getRandomColor() {
  const r = Math.floor(Math.random() * 156) + 100; // 100~255，避免太暗
  const g = Math.floor(Math.random() * 156) + 100;
  const b = Math.floor(Math.random() * 156) + 100;
  return `rgb(${r}, ${g}, ${b})`;
}

async function fetchChartData() {
    const res = await fetch(`/api/chart-data/?coin_id=${coinId}`);
    if (!res.ok) throw new Error("無法取得資料");
    return res.json();
}

// 呼叫 API
  fetchChartData(coinId).then(data => {
    console.log("圖表資料:", data);
  }).catch(err => console.error(err));

function renderCharts(data) {
  // 先銷毀舊的圖表
  [priceChart, rsiChart, stochChart, cciChart, williamsChart, obvChart, mfiChart, atrChart]
    .forEach(c => { if(c) c.destroy(); });

  // 價格圖
  const ctxPrice = document.getElementById('priceChart').getContext('2d');
  priceChart = new Chart(ctxPrice, {
    type: 'line',
    data: {
      labels: data.dates,
      datasets: [
        { label: '收盤價', data: data.close, borderColor: getRandomColor(), fill: false },
        { label: 'EMA20', data: data.ema20, borderColor: getRandomColor(), fill: false },
        { label: 'BB High', data: data.bb_high, borderColor: getRandomColor(), borderDash: [5,5], fill: false },
        { label: 'BB Low', data: data.bb_low, borderColor: getRandomColor(), borderDash: [5,5], fill: false }
      ]
    },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - 價格相關` } } }
  });

  // RSI
  rsiChart = new Chart(document.getElementById('rsiChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'RSI', data: data.rsi, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - RSI` } } }
  });

  // Stochastic
  stochChart = new Chart(document.getElementById('stochChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'Stochastic', data: data.stoch, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - Stochastic` } } }
  });

  // CCI
  cciChart = new Chart(document.getElementById('cciChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'CCI', data: data.cci, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - CCI` } } }
  });

  // Williams %R
  williamsChart = new Chart(document.getElementById('williamsChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'Williams %R', data: data.williams_r, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - Williams %R` } } }
  });

  // OBV
  obvChart = new Chart(document.getElementById('obvChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'OBV', data: data.obv, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - OBV` } } }
  });

  // MFI
  mfiChart = new Chart(document.getElementById('mfiChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'MFI', data: data.mfi, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - MFI` } } }
  });

  // ATR
  atrChart = new Chart(document.getElementById('atrChart').getContext('2d'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'ATR', data: data.atr, borderColor: getRandomColor(), fill: false }] },
    options: { responsive: true, plugins: { title: { display: true, text: `${data.selected_coin_name} - ATR` } } }
  });

}

async function init() {
  try {
    const data = await fetchChartData();
    renderCharts(data);
  } catch(err) {
    alert("初始化失敗：" + err.message);
  }
}

init();
</script>
