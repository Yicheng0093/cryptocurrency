{% extends 'base.html' %}
{% load static %}

{% block title %}AI 聊天{% endblock %}

{% block main %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<!-- <img src="{% static 'images/bot.png' %}"> -->
<div class="chat-container-page1">
  <div class="chat-messages"></div>
  <div class="module-select">
    <label><input type="checkbox" value="news" checked> 新聞</label>
    <label><input type="checkbox" value="price" checked> 價格</label>
    <label><input type="checkbox" value="other" checked> 其他經濟數據</label>
    <label><input type="checkbox" value="questionnaire" checked> 問卷</label>
  </div>
  <div class="chat-input">
    <input type="text" class="userInput-page1" placeholder="輸入訊息..." />
    <button class="sendBtn-page1" type="button">送出</button>
  </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<style>
.chat-container-page1 {
  width: 95%;
  max-width: 1400px;
  margin: 20px auto;
  background: linear-gradient(145deg, #ffffff, #f9fbff);
  border-radius: 28px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  height: 100vh;
  min-height: 600px;
  overflow: hidden;
  padding: 16px;
  font-family: 'Inter', sans-serif;
  backdrop-filter: blur(6px);
}

/* 手機自適應 */
@media (max-width: 768px) {
  .chat-container-page1 {
    width: 98%;
    height: 90vh;
    border-radius: 20px;
    min-height: 500px;
    padding: 12px;
  }
}

.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  min-height: 200px;
  background: #f8fafc;
  border-radius: 20px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.03);
}

/* 訊息樣式 */
.message {
  margin-bottom: 16px;
  padding: 14px 18px;
  border-radius: 18px;
  max-width: 75%;
  word-wrap: break-word;
  font-size: 15px;
  line-height: 1.5;
  animation: fadeIn 0.3s ease;
}
.message.user {
  background: linear-gradient(135deg, #d0ebff, #b5e3ff);
  align-self: flex-end;
  width: fit-content;
  height: auto;
}
.bot {
  background: linear-gradient(135deg, #f1f3f5, #e8ebee);
  align-self: flex-start;
}

.other {

  background: #ffffff;
  color: #333;
  align-self: flex-start;
  margin-right: auto;
  border-bottom-left-radius: 5px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.message.loading {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 20px;            /* 放大字體 */
  color: #0c4a6e;
  background: linear-gradient(135deg, #d0f0ff, #a0e0ff);
  border-radius: 16px;
  padding: 10px 16px;          /* 放大 padding 配合大字 */
  max-width: 90%;
  width: fit-content;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  animation: float 1.2s ease-in-out infinite, pulse 1.5s infinite alternate;
  white-space: nowrap;
  overflow: hidden;
  line-height: 1.2;            /* 適應大字 */
}

/* 文字特效 */
.message.loading span {
  display: inline-block;
  background: linear-gradient(90deg, #0c4a6e, #3b82f6, #0c4a6e);
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: textWave 2s linear infinite;
}


/* 文字漸變流動動畫 */
@keyframes textWave {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* 點點容器 */
.message.loading .dots {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

/* 點點 */
.message.loading .dots span {
  display: block;
  width: 8px;      /* 配合大字放大點 */
  height: 8px;
  background: #0c4a6e;
  border-radius: 50%;
  animation: bounce 1.2s infinite ease-in-out;
}


.message.loading .dots span:nth-child(1) { animation-delay: 0s; }
.message.loading .dots span:nth-child(2) { animation-delay: 0.2s; }
.message.loading .dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
  40% { transform: scale(1); opacity: 1; }
}


/* 模組標籤 */
.module-tags {
  margin-top: 6px;
  font-size: 0.85rem;
  color: #555;
}
.module-tags span {
  background: #e0e0e0;
  border-radius: 12px;
  padding: 2px 8px;
  margin-right: 4px;
  display: inline-block;
}

/* 輸入區 */
.chat-input {
  display: flex;
  border-top: 1px solid #dbeafe;
  background: #f9fbff;
  border-radius: 14px;
  overflow: hidden;
  margin-top: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.chat-input input {
  flex: 1;
  padding: 14px;
  border: none;
  outline: none;
  font-size: 16px;
  background: transparent;
}
.chat-input button {
  background: linear-gradient(135deg, #4facfe, #00f2fe);
  color: white;
  border: none;
  padding: 14px 22px;
  font-size: 16px;
  cursor: pointer;
  transition: transform 0.15s, opacity 0.2s;
}
.chat-input button:hover {
  opacity: 0.9;
  transform: scale(1.05);
}


/* 模組選擇容器 */
.module-select {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
}

/* 每個模組卡片 */
.module-select label {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  border-radius: 18px;
  background: #F0F5FF;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.03);
}
.module-select label:hover {
  background: #E0F2FE;
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

/* checkbox 样式 */
.module-select input[type="checkbox"] {
  margin-right: 8px;
  accent-color: #3B82F6;
}

/* 勾選效果 (讓整個label變色) */
.module-select input[type="checkbox"]:checked + span,
.module-select input[type="checkbox"]:checked + label {
  background: linear-gradient(135deg, #3B82F6, #2563EB);
  color: #fff;
}

@keyframes fadeIn {
  from {opacity: 0; transform: translateY(4px);}
  to {opacity: 1; transform: translateY(0);}
}
</style>

<script>
(function(){
  const container = document.querySelector(".chat-container-page1");
  if (!container) return;

  const sendBtn = container.querySelector(".sendBtn-page1");
  const input = container.querySelector(".userInput-page1");
  const messages = container.querySelector(".chat-messages");
  const csrftoken = document.querySelector('[name=csrf-token]').content;


  window.chatCharts = window.chatCharts || [];

  // appendMessage 改成支援 loading
function appendMessage(messagesContainer, text, sender, isTag=false, extraData=null) {
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.classList.add('message');
  const allLoadingDivs = messagesContainer.querySelectorAll('.loading');
  allLoadingDivs.forEach(d => d.remove());


  if (isTag) {
    text = text.replace(/^分類：/, '').trim();
    const tags = text.split(',').map(t => t.trim()).filter(t => t.length > 0);
    if (tags.length > 0) {
      const tagContainer = document.createElement('div');
      tagContainer.className = 'module-tags';

      const labelSpan = document.createElement('span');
      labelSpan.textContent = '分類：';
      labelSpan.style.fontWeight = 'bold';
      tagContainer.appendChild(labelSpan);

      tags.forEach(t => {
        const span = document.createElement('span');
        span.textContent = t;
        tagContainer.appendChild(span);
      });

      div.appendChild(tagContainer);
    }
  } else if (sender === "user") {
    const p = document.createElement('p');
    p.textContent = text;
    div.appendChild(p);
  } else if (sender === 'other') {
    const p = document.createElement('p');
    p.textContent = text;
    div.appendChild(p);

    if (extraData && extraData.length ) {
      const canvas = document.createElement('canvas');
    }

  } else if (sender === "user") {
    const p = document.createElement('p');
    p.textContent = text;
    div.appendChild(p);

  } else if (sender === "loding") {
    div.classList.add('message', 'loading');

    // 文字部分
    const spanText = document.createElement('span');
    spanText.textContent = text;   // 例如 "生成中"
    div.appendChild(spanText);

    // 動態點點部分
    const dotSpan = document.createElement('span');
    dotSpan.className = 'dots';

    // 建立三個 span，配合 CSS 跳動動畫
    for (let i = 0; i < 3; i++) {
      const dot = document.createElement('span');
      dotSpan.appendChild(dot);
    }

    div.appendChild(dotSpan);

    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    return div;  // 保存 div 方便後續刪除

  } else if (sender === "bot") {
    if (extraData && extraData.length) {
      const p = document.createElement('p');
      p.textContent = text;
      div.appendChild(p);

      // ===== Candlestick K 線圖 =====
      const canvas = document.createElement('canvas');
      canvas.style.width = '300px';
      canvas.style.height = '200px';
      div.appendChild(canvas);

      const candleData = extraData.map(item => ({
        x: new Date(item.day.trim()),
        o: parseFloat(item.open),
        h: parseFloat(item.high),
        l: parseFloat(item.low),
        c: parseFloat(item.close)
      }));

      if (canvas.chartInstance) canvas.chartInstance.destroy();

      const paddedCandleData = [
        { x: new Date(candleData[0].x.getTime() - 24*60*60*1000), o: null, h: null, l: null, c: null },
        ...candleData,
        { x: new Date(candleData[candleData.length - 1].x.getTime() + 24*60*60*1000), o: null, h: null, l: null, c: null }
      ];

      const prices = candleData.flatMap(d => [d.h, d.l]);
      const minPrice = Math.min(...prices);
      const maxPrice = Math.max(...prices);
      const coinName = extraData.length ? extraData[0].coin : '幣種';

      const chart = new Chart(canvas, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: `${coinName} 價格`,
            data: paddedCandleData,
            barPercentage: 0.2,
            categoryPercentage: 0.2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const d = context[0].raw;
                  if (!d || d.o === null) return '';
                  const date = new Date(d.x);
                  return `${date.getMonth()+1}月${date.getDate()}日`;
                },
                label: function(context) {
                  const d = context.raw;
                  if (!d || d.o === null) return '';
                  return `開:${d.o} 高:${d.h} 低:${d.l} 收:${d.c}`;
                }
              }
            }
          },
          scales: {
            x: {
            type: 'time',
            time: { unit: 'day', tooltipFormat: 'MM/dd' },
            offset: true,
            ticks: {
              autoSkip: false,
              maxRotation: 0,
              callback: function(value, index, ticks) {
                let dateVal = value;
                if (value instanceof Date) dateVal = value;
                else if (typeof value === 'number') dateVal = new Date(value);
                else if (value && value.raw) dateVal = new Date(value.raw.x);
                return `${dateVal.getMonth()+1}月${dateVal.getDate()}日`;
              }
            }
          }
          ,
            y: {
              title: { display: true, text: '價格 (USD)' },
              beginAtZero: false,
              min: minPrice * 0.995,
              max: maxPrice * 1.005
            }
          }
        }
      });
      canvas.chartInstance = chart;
      window.chatCharts.push(chart);

      // ===== 成交量圖 =====
      const volCanvas = document.createElement('canvas');
      volCanvas.style.width = '300px';
      volCanvas.style.height = '100px';
      div.appendChild(volCanvas);

      const volChart = new Chart(volCanvas, {
        type: 'bar',
        data: {
          labels: extraData.map(item => new Date(item.day.trim())),
          datasets: [{
            label: '成交量',
            data: extraData.map(i => parseFloat(i.volume)),
            backgroundColor: 'rgba(0,123,255,0.5)',
            barPercentage: 0.5
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                title: function(context) {
                  const d = context[0].parsed.x;
                  const date = new Date(d);
                  return `${date.getMonth() + 1}月${date.getDate()}日`;
                },
                label: function(context) {
                  return `成交量: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day' },
              ticks: {
                callback: function(value, index, ticks) {
                  const date = new Date(ticks[index].value);
                  return `${date.getMonth() + 1}月${date.getDate()}日`;
                },
                autoSkip: true,
                maxRotation: 0
              }
            },
            y: {
              title: { display: true, text: '交易量' }
            }
          }
        }
      });
      
      window.chatCharts.push(volChart);
    
    
    } else {
      const p = document.createElement('p');
      p.innerHTML = text;
      div.appendChild(p);
    }

  }

  messagesContainer.appendChild(div);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

  window.agentLoadingDivs = window.agentLoadingDivs || {};

  function sendMessage() {
    const selectedModules = Array.from(container.querySelectorAll(".module-select input:checked"))
      .map(cb => cb.value);
    const text = input.value.trim();
    if (!text) return;


    appendMessage(messages, text, "user");
    input.value = '';

    // 初始化每個 agent 的生成中 div
    

    if (window.currentEventSource) {

      window.currentEventSource.close();
    }

    const payload = { user_input: text, selected_modules: selectedModules };


    const es = new EventSource('/report/api/classify/?payload=' + encodeURIComponent(JSON.stringify(payload)));
    window.currentEventSource = es;

    es.onmessage = function(e) {

      try {
        const data = JSON.parse(e.data);

        // 顯示分類結果
        if (data.classifications) {

          appendMessage(messages, data.classifications.join(', '), 'bot', true);
        }

        if (data.progress && data.result) {
          const ans = data.result;
          const agent = ans.module;
          console.log(ans,agent);


            
          // 顯示最終訊息
          if (agent === "price") {
            appendMessage(messages, ans.text, 'bot', false, ans.data);
          } else if (agent === "other") {
            appendMessage(messages, ans.text, 'other', false, ans.data);
          } else if (agent === "loding") { 
            appendMessage(messages, ans.text, 'loding', false, ans.data);
            
          } else {
            appendMessage(messages, ans.text + '<br>' + (ans.data || ''), 'bot');
          }
        }

        // 顯示整合回覆
        if (data.integrated_summary) {

          appendMessage(messages, '整合回覆：' + data.integrated_summary, 'bot');
        }

      } catch(err) { console.error('解析 SSE 訊息錯誤', err); }
    };

    es.addEventListener('end', () => {

      es.close();
    });
    es.onerror = () => {

      es.close();
    }
  }



  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

})();
</script>


{% endblock %}