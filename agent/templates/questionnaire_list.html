{% extends 'base.html' %}

{% load static %}
{% block title %}問卷首頁{% endblock %}

{% block content %}
{% load humanize %}
<link rel="stylesheet" href="{% static 'css/question_list.css' %}">

<h1>問卷首頁</h1>
<hr>
    <div>
        <button class="analysis" id="analysisBtn">
            <span>
                <a href="{% url 'agent:analysis_result_view' %}" style="color: #fff;">執行總分析</a>
            </span>
        </button>
        <div id="tooltip">
            特別提醒：問卷第 2、3、4、9 題將用來計算您的風險屬性分數，請務必仔細填寫。
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<!-- Canvas -->
<table class="table table-bordered align-middle text-center">
    <thead class="table-light">
        <tr>
            <th class="text-center" style="width: 20%;">問卷名稱&nbsp;(點擊問卷名稱開始填寫)</th>
            <th class="text-center" style="width: 15%;">最後填寫時間</th>
            <th class="text-center" style="width: 10%;">進度</th>
            <th class="text-center" style="width: 15%;">操作</th>
        </tr>
    </thead>
    <tbody>
        {% for item in data %}
        <tr>
            <td class="tooltip table table-bordered align-middle text-start" style = "text-indent: 3em;">
                <a href="{% url 'agent:questionnaire_detail' item.questionnaire.id %}">
                    {{ item.questionnaire.id }}. {{ item.questionnaire.title }}
                </a>
                
                {% if item.questionnaire.description %}
                <span class="tooltip-text">{{ item.questionnaire.description }}</span>
                {% endif %}
            </td>
            
            <td style="width: 15%;">
                {% if item.last_completed %}
                {{ item.last_completed|date:"Y-m-d H:i" }}
                {% else %}
                尚未填寫
                {% endif %}
            </td>
            
            <td style="width: 10%;">
                <div class="progress" style="height: 20px; position: relative;">
                    <div class="progress-bar 
                        {% if item.progress == 100 %}
                            bg-success
                        {% elif item.progress >= 50 %}
                            bg-info
                        {% elif item.progress > 0 %}
                            bg-warning
                        {% else %}
                            bg-transparent
                        {% endif %}" 
                        role="progressbar" 
                        style="width: {{ item.progress }}%;" 
                        aria-valuenow="{{ item.progress }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                    <span
                        style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.9rem;">
                        {{ item.progress }}%
                    </span>
                </div>
            </td>
            
            <td style="white-space: nowrap; width: 15%;">
                <div class="d-inline-flex gap-2 justify-content-center">
                    <form action="{% url 'agent:reset_questionnaire_answers' item.questionnaire.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('確定要清除所有答案並重新填寫嗎？');">
                            重新填寫此問卷
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6">目前沒有問卷</td>
        </tr>
        {% endfor %}
    </tbody>

</table>


{% if know %}
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- 標題 -->
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="infoModalLabel">重要提醒</h5>
            </div>

            <!-- 說明文字 -->
            <div class="modal-body px-3 text-start">
                <p class="mb-3">
                <p style="text-indent: 1em;">
                    了解您是哪一類型的投資人，是成功規劃投資的第一步。透過這份問卷，您將能深入認識自己的<span class="fw-semibold">風險承受能力</span>、<span
                        class="fw-semibold">投資期限</span>與<span class="fw-semibold">目標</span>。
                </p>
                <p style="text-indent: 1em;">
                    雖然這份問卷是與財務顧問溝通的良好起點，但它並不取代<span class="fw-semibold">專業顧問所進行的全面風險評估</span>。
                </p>
                </p>

                <div class="alert alert-warning mb-3 text-start">
                    <strong>特別提醒：</strong> 問卷第 <strong>2、3、4、9</strong> 題將用來計算您的風險屬性分數，請務必仔細填寫。
                </div>
                <p class="fw-bold text-success mb-3 text-center">
                    開始填寫，讓我們一起打造符合您需求的投資策略！
                </p>

                <!-- 勾選框 -->
                <div class="form-check d-flex justify-content-center align-items-center mt-4">
                    <input class="form-check-input me-2" type="checkbox" id="agreeCheck">
                    <label class="form-check-label fw-semibold mb-0" for="agreeCheck">
                        我了解
                    </label>
                </div>
            </div>

            <!-- 底部按鈕 -->
            <form method="post" class="modal-footer w-100 d-flex justify-content-center">
                {% csrf_token %}
                <button type="submit" name="know_confirm" 
                id="btnUnderstand" 
                class="btn btn-primary w-100" 
                disabled 
                data-bs-dismiss="modal">
                確定
            </button>
            </form>
        </div>
    </div>
</div>
{% endif %}



<script src="{% static 'js/question_list.js' %}"></script>

<script>
    const agreeCheck = document.getElementById("agreeCheck");
    const btnUnderstand = document.getElementById("btnUnderstand");

    agreeCheck.addEventListener("change", function () {
        btnUnderstand.disabled = !this.checked;
    });

    // 點確定就關閉 Modal
    btnUnderstand.addEventListener("click", function () {
        const modal = bootstrap.Modal.getInstance(document.getElementById('infoModal'));
        modal.hide();
    });

document.addEventListener("DOMContentLoaded", function () {
  const checkbox = document.getElementById("agreeCheck");
  const btn = document.getElementById("btnUnderstand");

  checkbox.addEventListener("change", function () {
    btn.disabled = !checkbox.checked;
  });

  btn.addEventListener("click", function () {
    fetch("", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "know_confirm=1"
    }).then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          // 關閉 Modal
          const modal = bootstrap.Modal.getInstance(document.getElementById("infoModal"));
          modal.hide();
          // 🔹 主動刷新頁面，現在是 GET 狀態，不會跳提示
          window.location.reload();
        }
      });
  });

  const infoModal = new bootstrap.Modal(document.getElementById("infoModal"));
  infoModal.show();
  });
</script>


{% endblock %}